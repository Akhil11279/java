
import org.springframework.context.annotation.*;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.hibernate.*;
import org.hibernate.cfg.Configuration;
import jakarta.persistence.*;

import java.util.List;

// ----------------------------------------------------
// PART (a): SPRING DEPENDENCY INJECTION (Java Config)
// ----------------------------------------------------

class Course {
    private String courseName = "Spring Framework with Hibernate";

    public String getCourseName() {
        return courseName;
    }
}

class StudentDI {
    private Course course;

    public StudentDI(Course course) {
        this.course = course;
    }

    public void showInfo() {
        System.out.println("Student enrolled in: " + course.getCourseName());
    }
}

@Configuration
class AppConfig {
    @Bean
    public Course course() {
        return new Course();
    }

    @Bean
    public StudentDI studentDI() {
        return new StudentDI(course());
    }
}

// ----------------------------------------------------
// PART (b): HIBERNATE CRUD (Student Entity)
// ----------------------------------------------------

@Entity
@Table(name = "Student")
class StudentEntity {
    @Id
    private int id;
    private String name;
    private String department;
    private double marks;

    public StudentEntity() {}
    public StudentEntity(int id, String name, String department, double marks) {
        this.id = id;
        this.name = name;
        this.department = department;
        this.marks = marks;
    }

    // Getters/Setters
    public int getId() { return id; }
    public String getName() { return name; }
    public String getDepartment() { return department; }
    public double getMarks() { return marks; }
    public void setId(int id) { this.id = id; }
    public void setName(String name) { this.name = name; }
    public void setDepartment(String department) { this.department = department; }
    public void setMarks(double marks) { this.marks = marks; }
}

class HibernateUtil {
    private static SessionFactory factory;

    static {
        try {
            factory = new Configuration()
                    .configure("hibernate.cfg.xml")
                    .addAnnotatedClass(StudentEntity.class)
                    .addAnnotatedClass(Account.class)
                    .buildSessionFactory();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static SessionFactory getSessionFactory() {
        return factory;
    }
}

class StudentDAO {
    public void create(StudentEntity s) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction tx = session.beginTransaction();
        session.save(s);
        tx.commit();
        session.close();
        System.out.println("Student Added: " + s.getName());
    }

    public List<StudentEntity> readAll() {
        Session session = HibernateUtil.getSessionFactory().openSession();
        List<StudentEntity> list = session.createQuery("from StudentEntity", StudentEntity.class).list();
        session.close();
        return list;
    }

    public void update(StudentEntity s) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction tx = session.beginTransaction();
        session.update(s);
        tx.commit();
        session.close();
        System.out.println("Student Updated: " + s.getName());
    }

    public void delete(int id) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction tx = session.beginTransaction();
        StudentEntity s = session.get(StudentEntity.class, id);
        if (s != null) session.delete(s);
        tx.commit();
        session.close();
        System.out.println("Student Deleted with ID: " + id);
    }
}

// ----------------------------------------------------
// PART (c): SPRING + HIBERNATE TRANSACTION MANAGEMENT
// ----------------------------------------------------

@Entity
@Table(name = "Account")
class Account {
    @Id
    private int accountId;
    private String holderName;
    private double balance;

    public Account() {}
    public Account(int id, String name, double balance) {
        this.accountId = id;
        this.holderName = name;
        this.balance = balance;
    }

    public int getAccountId() { return accountId; }
    public String getHolderName() { return holderName; }
    public double getBalance() { return balance; }
    public void setAccountId(int accountId) { this.accountId = accountId; }
    public void setHolderName(String holderName) { this.holderName = holderName; }
    public void setBalance(double balance) { this.balance = balance; }
}

@Service
class BankService {
    @Transactional
    public void transferMoney(int fromAcc, int toAcc, double amount) {
        Session session = HibernateUtil.getSessionFactory().openSession();
        Transaction tx = session.beginTransaction();

        try {
            Account from = session.get(Account.class, fromAcc);
            Account to = session.get(Account.class, toAcc);

            if (from == null || to == null)
                throw new Exception("Account not found!");
            if (from.getBalance() < amount)
                throw new Exception("Insufficient funds!");

            from.setBalance(from.getBalance() - amount);
            to.setBalance(to.getBalance() + amount);

            session.update(from);
            session.update(to);
            tx.commit();

            System.out.println("₹" + amount + " transferred from " + fromAcc + " → " + toAcc);
        } catch (Exception e) {
            tx.rollback();
            System.out.println("Transaction Failed: " + e.getMessage());
        } finally {
            session.close();
        }
    }
}

// ----------------------------------------------------
// MAIN APPLICATION (Runs All Parts)
// ----------------------------------------------------
public class Experiment3_2 {
    public static void main(String[] args) {
        System.out.println("===== Experiment 3.2: Spring + Hibernate =====");

        // ---- PART (a): Spring Dependency Injection ----
        AnnotationConfigApplicationContext context =
                new AnnotationConfigApplicationContext(AppConfig.class);
        StudentDI student = context.getBean(StudentDI.class);
        student.showInfo();

        // ---- PART (b): Hibernate CRUD Operations ----
        StudentDAO dao = new StudentDAO();
        dao.create(new StudentEntity(1, "Alice", "CSE", 88));
        dao.create(new StudentEntity(2, "Bob", "IT", 91));
        dao.readAll().forEach(s ->
                System.out.println("Student: " + s.getName() + ", Marks: " + s.getMarks()));

        dao.update(new StudentEntity(1, "Alice", "CSE", 95));
        dao.delete(2);

        // ---- PART (c): Spring + Hibernate Transaction ----
        BankService bank = new BankService();
        bank.transferMoney(101, 102, 500.0);

        context.close();
        System.out.println("===== Experiment Completed =====");
    }
}
